{% extends "translation-manager/_layouts/cp" %}
{% set title = "Import/Export"|t('translation-manager') %}
{% set fullPageForm = false %}
{% set selectedSubnavItem = 'import-export' %}

{% set plugin = craft.app.plugins.getPlugin('translation-manager') %}
{% set crumbs = [
    {
        label: translationHelper.fullName|t('translation-manager'),
        url: url('translation-manager'),
    },
    {
        label: 'Import/Export'|t('translation-manager'),
        url: url('translation-manager/import-export'),
    },
] %}

{% set canImportExport = currentUser.can('translationManager:importTranslations')
    or currentUser.can('translationManager:exportTranslations') %}
{% set canViewHistory = currentUser.can('translationManager:viewImportHistory') %}
{% set canClearHistory = currentUser.can('translationManager:clearImportHistory') %}

{% set tabs = {} %}

{% if canImportExport %}
    {% set tabs = tabs|merge({
        importExport: {
            label: 'Import/Export'|t('translation-manager'),
            url: '#import-export',
        },
    }) %}
{% endif %}

{% if canViewHistory %}
    {% set tabs = tabs|merge({
        history: {
            label: 'Import History'|t('translation-manager'),
            url: '#history',
        },
    }) %}
{% endif %}

{# Check if we should select the history tab #}
{% if craft.app.request.getSegment(3) == 'import-export' and '#history' in craft.app.request.url %}
    {% set selectedTab = 'history' %}
{% endif %}
{% if not canImportExport and canViewHistory %}
    {% set selectedTab = 'history' %}
{% endif %}

{% import "_includes/forms" as forms %}

{% block content %}
<div id="import-export">
    {% if currentUser.can('translationManager:exportTranslations') %}
    <h2>{{ "Export Translations"|t('translation-manager') }}</h2>
    <p class="light" style="margin-bottom: 16px;">{{ "Download translations for backup or migration."|t('translation-manager') }}</p>

    <form method="post" action="{{ actionUrl('translation-manager/export') }}">
        {{ csrfInput() }}

        <div class="flex" style="gap: 12px; align-items: center; flex-wrap: wrap;">
            {% set languageOptions = [{value: '', label: 'All Languages'|t('translation-manager')}] %}
            {% for lang in uniqueLanguages %}
                {% set languageOptions = languageOptions|merge([{value: lang, label: lang|upper}]) %}
            {% endfor %}
            {{ forms.select({
                id: 'exportLanguage',
                name: 'language',
                options: languageOptions,
                value: ''
            }) }}

            {% set categoryOptions = [{value: '', label: 'All Categories'|t('translation-manager')}] %}
            {% if settings.enableFormieIntegration %}
                {% set categoryOptions = categoryOptions|merge([{value: 'formie', label: craft.translationManager.getFormiePluginName()}]) %}
            {% endif %}
            {% if settings.enableSiteTranslations %}
                {% for category in settings.getEnabledCategories() %}
                    {% set categoryOptions = categoryOptions|merge([{value: category, label: category|title}]) %}
                {% endfor %}
            {% endif %}
            {{ forms.select({
                id: 'exportCategory',
                name: 'category',
                options: categoryOptions,
                value: ''
            }) }}

            {% set statusOptions = [
                {value: '', label: 'All Statuses'|t('translation-manager')},
                {value: 'pending', label: 'Pending'|t('translation-manager')},
                {value: 'translated', label: 'Translated'|t('translation-manager')},
                {value: 'unused', label: 'Unused'|t('translation-manager')},
            ] %}
            {{ forms.select({
                id: 'exportStatus',
                name: 'status',
                options: statusOptions,
                value: ''
            }) }}

            <button type="submit" class="btn secondary">
                {{ "Export CSV"|t('translation-manager') }}
            </button>
        </div>
    </form>

    <hr>
    {% endif %}

    {% if currentUser.can('translationManager:importTranslations') %}
    <h2>{{ "Import Translations"|t('translation-manager') }}</h2>

    {% set csvFormatTip %}
        <h4>{{ "CSV Format"|t('translation-manager') }}</h4>
        <p><strong>{{ "Required columns:"|t('translation-manager') }}</strong></p>
        <ul>
            <li><strong>Translation Key</strong> - {{ "The source text (accepts: Translation Key, English, Source)"|t('translation-manager') }}</li>
        </ul>
        <p><strong>{{ "Optional columns:"|t('translation-manager') }}</strong></p>
        <ul>
            <li><strong>Translation</strong> - {{ "The translated text"|t('translation-manager') }}</li>
            <li><strong>Language</strong> - {{ "Target language code (e.g., ar, fr, en-US)"|t('translation-manager') }}</li>
            <li><strong>Category</strong> - {{ "Translation category (e.g., lindemannrock, formie)"|t('translation-manager') }}</li>
            <li><strong>Context</strong> - {{ "Translation context (defaults to 'site')"|t('translation-manager') }}</li>
            <li><strong>Status</strong> - {{ "pending, translated, or unused"|t('translation-manager') }}</li>
        </ul>
        <p><strong>{{ "Example:"|t('translation-manager') }}</strong></p>
        <pre style="background: #f3f4f6; padding: 8px; border-radius: 4px; font-size: 12px;">Translation Key,Translation,Language,Category
"Welcome","مرحباً","ar","lindemannrock"
"Contact Us","اتصل بنا","ar","lindemannrock"
"Submit","Soumettre","fr","lindemannrock"</pre>
    {% endset %}

    {% set maxRows = importLimits.maxRows ?? 4000 %}
    {% set maxBytes = importLimits.maxBytes ?? 5242880 %}
    {% set maxSize = craft.app.formatter.asShortSize(maxBytes, 2) %}

    {% set phpImportHtml = null %}
    {% if craft.app.config.general.devMode %}
        {% set phpFormatTip %}
            <h4>{{ "PHP File Import"|t('translation-manager') }}</h4>
            <p><strong>{{ "For client onboarding:"|t('translation-manager') }}</strong></p>
            <ul>
                <li>{{ "Import existing PHP translation files into the database"|t('translation-manager') }}</li>
                <li>{{ "Files must be in your configured translations folder"|t('translation-manager') }}</li>
            </ul>
            <p><strong>{{ "Expected file structure:"|t('translation-manager') }}</strong></p>
            <pre style="background: #f3f4f6; padding: 8px; border-radius: 4px; font-size: 12px;">translations/
├── en/
│   └── lindemannrock.php
└── ar/
    └── lindemannrock.php</pre>
            <p><strong>{{ "Multi-language behavior:"|t('translation-manager') }}</strong></p>
            <ul>
                <li>{{ "Creates records for ALL site languages"|t('translation-manager') }}</li>
                <li>{{ "Source language auto-filled with key as translation"|t('translation-manager') }}</li>
                <li>{{ "Other languages set to pending"|t('translation-manager') }}</li>
            </ul>
            <p class="light" style="margin-top: 8px;">{{ "Only available in devMode"|t('translation-manager') }}</p>
        {% endset %}

        {% set phpBackupEnabled = settings.backupEnabled %}
        {% set phpBackupOnImport = settings.backupOnImport %}

        {% set phpImportHtml %}
            <div class="field">
                <div class="heading">
                    <label>{{ "Import from PHP Files"|t('translation-manager') }}</label>
                    <span class="info">{{ phpFormatTip|raw }}</span>
                    <div class="instructions">
                        <p style="margin-bottom: 12px;">{{ "Import existing translations from PHP files in your translations folder"|t('translation-manager') }}</p>
                    </div>
                </div>
                    <div class="input">
                    <div id="php-file-input-section">
                        <div class="flex" style="gap: 12px; align-items: center; flex-wrap: wrap;">
                            {{ forms.select({
                                id: 'phpFile',
                                name: 'phpFile',
                                options: [{value: '', label: 'Select a file'|t('translation-manager')}],
                                value: ''
                            }) }}
                            {{ forms.select({
                                id: 'phpLanguage',
                                name: 'phpLanguage',
                                options: [{value: '', label: 'Select file first'|t('translation-manager')}],
                                value: ''
                            }) }}
                            {{ forms.select({
                                id: 'phpCategory',
                                name: 'phpCategory',
                                options: [{value: '', label: 'Select file first'|t('translation-manager')}],
                                value: ''
                            }) }}
                        </div>
                        {{ forms.lightswitchField({
                            label: 'Create Backup Before Import'|t('translation-manager'),
                            instructions: 'Automatically backup existing translations before importing (recommended)'|t('translation-manager'),
                            id: 'phpCreateBackup',
                            name: 'phpCreateBackup',
                            on: phpBackupEnabled and phpBackupOnImport,
                            disabled: not phpBackupEnabled,
                            warning: not phpBackupEnabled ? 'Backups are disabled in settings.'|t('translation-manager') : null,
                        }) }}
                        {% include 'lindemannrock-base/_components/info-box' with {
                            message: 'Only import PHP files from trusted sources. Files are parsed safely without code execution, but only standard return array syntax is supported.'|t('translation-manager'),
                            type: 'warning',
                        } %}
                        <div class="buttons">
                            <button type="button" class="btn submit" id="php-preview-btn" disabled>
                                {{ "Preview"|t('translation-manager') }}
                            </button>
                        </div>
                    </div>

                    <div id="php-preview-section" style="margin-top: 20px; display: none;">
                        <h3>{{ "Import Preview"|t('translation-manager') }}</h3>
                        {% include 'lindemannrock-base/_components/info-box' with {
                            message: '<strong>' ~ "Backup will be created automatically before importing to protect existing translations."|t('translation-manager') ~ '</strong>',
                            type: 'success',
                            variant: 'colored',
                            margin: 'bottom',
                            boxId: 'php-backup-notice',
                            hidden: true
                        } %}
                        <div id="php-preview-summary" style="margin-bottom: 12px; padding: 12px; background: #f3f4f6; border-radius: 4px;"></div>
                        <div id="php-preview-content" style="max-height: 400px; overflow-y: auto;"></div>
                        <div id="php-preview-buttons" style="margin-top: 12px;">
                            <button type="button" class="btn submit" id="php-confirm-import-btn">
                                {{ "Confirm and Import"|t('translation-manager') }}
                            </button>
                            <button type="button" class="btn" id="php-cancel-btn">
                                {{ "Cancel"|t('translation-manager') }}
                            </button>
                        </div>
                    </div>

                    <div id="php-import-results" style="margin-top: 20px; display: none;">
                        <div id="php-import-success" class="success" style="display: none;"></div>
                        <div id="php-import-error" class="error" style="display: none;"></div>
                    </div>
                </div>
            </div>
        {% endset %}
    {% endif %}

    {% include 'lindemannrock-base/_partials/import-csv' with {
        action: actionUrl('translation-manager/import/upload'),
        formId: 'translation-import-form',
        title: 'Import CSV'|t('translation-manager'),
        description: '',
        csvDescription: 'Import translations from a CSV file.'|t('translation-manager'),
        csvFormatTip: csvFormatTip,
        fileLabel: 'CSV File'|t('translation-manager'),
        fileInstructions: 'Select a CSV file to import translations'|t('translation-manager'),
        delimiterLabel: 'CSV Delimiter'|t('translation-manager'),
        delimiterInstructions: 'Character used to separate values in your CSV (auto-detect is default)'|t('translation-manager'),
        delimiterValue: 'auto',
        delimiterOptions: {
            'auto': 'Auto (detect)'|t('translation-manager'),
            ',': 'Comma (,)'|t('translation-manager'),
            ';': 'Semicolon (;)'|t('translation-manager'),
            "\t": 'Tab'|t('translation-manager'),
            '|': 'Pipe (|)'|t('translation-manager'),
        },
        showBackupToggle: true,
        backupLabel: 'Create Backup Before Import'|t('translation-manager'),
        backupInstructions: 'Automatically backup existing translations before importing (recommended)'|t('translation-manager'),
        backupEnabled: settings.backupEnabled,
        backupOnImport: settings.backupOnImport,
        backupWarning: 'Backups are disabled in settings.'|t('translation-manager'),
        infoBoxMessage: 'The maximum file size is {size} and the import is limited to {rows} rows per file.'|t('translation-manager', {
            size: maxSize,
            rows: maxRows|number_format
        }),
        submitLabel: 'Upload & Map Columns'|t('translation-manager'),
        showModeSwitch: phpImportHtml ? true : false,
        primaryLabel: 'CSV Import'|t('translation-manager'),
        secondaryLabel: 'PHP Import'|t('translation-manager'),
        secondaryHtml: phpImportHtml,
        modeDefault: 'csv',
        renderTitleInSection: true,
    } %}
    {% endif %}
</div>

{% if canViewHistory %}
<div id="history" class="hidden">
    <div class="flex" style="align-items: center; margin-bottom: 1rem;">
        <h2 style="margin: 0;">{{ "Import History"|t('translation-manager') }}</h2>
        {% if importHistory|length and canClearHistory %}
            <div style="margin-left: auto;">
                <button type="button" class="btn" id="clear-logs-btn">
                    {{ "Clear history"|t('translation-manager') }}
                </button>
            </div>
        {% endif %}
    </div>
    <p>{{ "Recent CSV imports and their results."|t('translation-manager') }}</p>

    {% if importHistory|length %}
        <table class="data fullwidth">
            <thead>
                <tr>
                    <th scope="col">{{ "Date"|t('translation-manager') }}</th>
                    <th scope="col">{{ "Created By"|t('translation-manager') }}</th>
                    <th scope="col">{{ "Filename"|t('translation-manager') }}</th>
                    <th scope="col">{{ "Size"|t('translation-manager') }}</th>
                    <th scope="col">{{ "Imported"|t('translation-manager') }}</th>
                    <th scope="col">{{ "Failed"|t('translation-manager') }}</th>
                    <th scope="col" class="rightalign">{{ "Backup"|t('translation-manager') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for import in importHistory %}
                    <tr>
                        <td class="thin">{{ import.formattedDate }}</td>
                        <td>{{ import.user }}</td>
                        <td>{{ import.filename ?? '-' }}</td>
                        <td><code style="font-size: 11px;">{{ import.formattedSize }}</code></td>
                        <td>
                            {% if import.imported > 0 %}
                                <span class="success">{{ "{count} new"|t('translation-manager', { count: import.imported|number_format }) }}</span>
                            {% endif %}
                            {% if import.updated > 0 %}
                                {% if import.imported > 0 %}<br>{% endif %}
                                <span style="color: #E67E22;">{{ "{count} updated"|t('translation-manager', { count: import.updated|number_format }) }}</span>
                            {% endif %}
                            {% if import.skipped > 0 %}
                                {% if import.imported > 0 or import.updated > 0 %}<br>{% endif %}
                                <span class="light">{{ "{count} skipped"|t('translation-manager', { count: import.skipped|number_format }) }}</span>
                            {% endif %}
                            {% if import.imported == 0 and import.updated == 0 and import.skipped == 0 %}
                                <span class="light">{{ "No changes"|t('translation-manager') }}</span>
                            {% endif %}
                        </td>
                        <td>{{ import.failed|number_format }}</td>
                        <td class="rightalign">
                            {% if import.backupPath %}
                                <a href="{{ url('translation-manager/backups') }}" class="go" title="{{ 'View backup'|t('translation-manager') }}">{{ "View"|t('translation-manager') }}</a>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="light">{{ "No imports found yet."|t('translation-manager') }}</p>
    {% endif %}
</div>
{% endif %}

{% include 'lindemannrock-base/_components/plugin-credit' %}
{% endblock %}



{% js %}
    // Check if we should show the history tab after reload
    if (sessionStorage.getItem('showHistoryTab') === 'true') {
        sessionStorage.removeItem('showHistoryTab');
        // Click the history tab
        const historyTab = document.querySelector('a[href="#history"]');
        if (historyTab) {
            historyTab.click();
        }
    }

    // Clear history button
    document.getElementById('clear-logs-btn')?.addEventListener('click', function(e) {
        e.preventDefault();

        if (!confirm('{{ "Are you sure you want to clear all import logs? This action cannot be undone."|t('translation-manager')|e('js') }}')) {
            return;
        }

        const button = this;
        button.classList.add('loading');
        button.disabled = true;

        Craft.sendActionRequest('POST', 'translation-manager/import/clear-logs')
            .then(() => {
                sessionStorage.setItem('showHistoryTab', 'true');
                window.location.reload(true);
            })
            .catch(error => {
                button.classList.remove('loading');
                button.disabled = false;
                Craft.cp.displayError(error.response?.data?.error || '{{ "Failed to clear history."|t('translation-manager')|e('js') }}');
            });
    });

    // PHP FILE IMPORT FUNCTIONALITY
    // ========================================

    let phpFiles = {};
    let phpPreviewData = null;
    window.phpImportData = []; // Store all items for import

    // Load available PHP files on page load
    async function loadPhpFiles() {
        try {
            const response = await fetch('{{ actionUrl('translation-manager/php-import/get-files') }}', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            const data = await response.json();

            if (data.success) {
                phpFiles = data.files;
                updatePhpFileDropdown();
            } else {
                console.error('Failed to load PHP files');
            }
        } catch (error) {
            console.error('Error loading PHP files:', error);
        }
    }

    function updatePhpFileDropdown() {
        const select = document.getElementById('phpFile');
        if (!select) return;

        let html = '<option value="">{{ "Select a file"|t('translation-manager') }}</option>';

        for (const [language, files] of Object.entries(phpFiles)) {
            html += `<optgroup label="${language}">`;
            for (const [filePath, fileInfo] of Object.entries(files)) {
                html += `<option value="${filePath}" data-language="${fileInfo.language}" data-category="${fileInfo.category}">${fileInfo.label}</option>`;
            }
            html += '</optgroup>';
        }

        if (Object.keys(phpFiles).length === 0) {
            html = '<option value="">{{ "No PHP files found in translations folder"|t('translation-manager') }}</option>';
        }

        select.innerHTML = html;
    }

    // Handle PHP file selection
    document.getElementById('phpFile')?.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const languageSelect = document.getElementById('phpLanguage');
        const categorySelect = document.getElementById('phpCategory');
        const previewBtn = document.getElementById('php-preview-btn');

        if (this.value && selectedOption) {
            const language = selectedOption.dataset.language || '';
            const category = selectedOption.dataset.category || '';

            // Update language dropdown with all site languages
            let languageHtml = '';
            const allSiteLanguages = {{ craft.app.sites.allSites|map(s => s.language)|unique|json_encode|raw }};
            allSiteLanguages.forEach(lang => {
                const selected = lang === language ? 'selected' : '';
                languageHtml += `<option value="${lang}" ${selected}>${lang}</option>`;
            });
            languageSelect.innerHTML = languageHtml;

            // Update category dropdown - include enabled categories + formie + detected category
            const enabledCategories = {{ settings.getEnabledCategories()|json_encode|raw }};
            const formieEnabled = {{ settings.enableFormieIntegration ? 'true' : 'false' }};

            // Build list of all available categories
            let allCategories = [...enabledCategories];

            // Add 'formie' if Formie integration is enabled and not already in list
            if (formieEnabled && !allCategories.includes('formie')) {
                allCategories.push('formie');
            }

            // Add the detected category from filename if not already in list
            if (category && !allCategories.includes(category)) {
                allCategories.push(category);
            }

            let categoryHtml = '';
            allCategories.forEach(cat => {
                const selected = cat === category ? 'selected' : '';
                categoryHtml += `<option value="${cat}" ${selected}>${cat}</option>`;
            });
            categorySelect.innerHTML = categoryHtml;

            previewBtn.disabled = false;
        } else {
            languageSelect.innerHTML = '<option value="">{{ "Select file first"|t('translation-manager') }}</option>';
            categorySelect.innerHTML = '<option value="">{{ "Select file first"|t('translation-manager') }}</option>';
            previewBtn.disabled = true;
        }

        // Hide preview section when file changes
        document.getElementById('php-preview-section').style.display = 'none';
        phpPreviewData = null;
    });

    // Handle PHP preview button
    document.getElementById('php-preview-btn')?.addEventListener('click', async function() {
        const file = document.getElementById('phpFile').value;
        const language = document.getElementById('phpLanguage').value;
        const category = document.getElementById('phpCategory').value;

        if (!file || !language || !category) {
            Craft.cp.displayError('Please select a file, language, and category');
            return;
        }

        this.classList.add('loading');
        this.disabled = true;

        try {
            const response = await fetch('{{ actionUrl('translation-manager/php-import/preview') }}', {
                method: 'POST',
                headers: {
                    'X-CSRF-Token': '{{ craft.app.request.csrfToken }}',
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    file,
                    language,
                    category,
                    createBackup: document.querySelector('input[name="phpCreateBackup"]')?.value === '1',
                    '{{ craft.app.config.general.csrfTokenName }}': '{{ craft.app.request.csrfToken }}'
                })
            });

            const data = await response.json();

            if (data.success) {
                phpPreviewData = { ...data, language, category };
                showPhpPreview(data);
            } else {
                Craft.cp.displayError(data.error || 'Failed to preview file');
            }
        } catch (error) {
            Craft.cp.displayError('Error previewing file: ' + error.message);
        } finally {
            this.classList.remove('loading');
            this.disabled = false;
        }
    });

    function showPhpPreview(data) {
        const previewSection = document.getElementById('php-preview-section');
        const summaryDiv = document.getElementById('php-preview-summary');
        const contentDiv = document.getElementById('php-preview-content');
        const buttonsDiv = document.getElementById('php-preview-buttons');
        const backupNotice = document.getElementById('php-backup-notice');
        const backupToggle = document.querySelector('input[name="phpCreateBackup"]');
        const backupEnabled = {{ (settings.backupEnabled and settings.backupOnImport) ? 'true' : 'false' }};

        // Clear and rebuild items array
        window.phpImportData = [];
        let index = 0;

        // Calculate how many will be processed
        const willProcess = data.counts.new + data.counts.existing;

        // Summary
        let summaryHtml = `<p><strong>{{ "Total entries:"|t('translation-manager') }}</strong> ${data.counts.new + data.counts.existing + data.counts.unchanged}</p>`;
        if (data.counts.new > 0) {
            summaryHtml += `<p><span class="success">{{ "New translations:"|t('translation-manager') }}</span> ${data.counts.new}</p>`;
        }
        if (data.counts.existing > 0) {
            summaryHtml += `<p><span style="color: #E67E22;">{{ "Will update:"|t('translation-manager') }}</span> ${data.counts.existing}</p>`;
        }
        if (data.counts.unchanged > 0) {
            summaryHtml += `<p><span class="light">{{ "Unchanged (will skip):"|t('translation-manager') }}</span> ${data.counts.unchanged}</p>`;
        }
        if (willProcess === 0) {
            summaryHtml += `<p class="warning" style="margin-top: 8px;">{{ "No changes to import. All translations are already up to date."|t('translation-manager') }}</p>`;
        }
        summaryDiv.innerHTML = summaryHtml;

        // Table
        let tableHtml = `
            <table class="data fullwidth">
                <thead>
                    <tr>
                        <th style="width: 40px;"><input type="checkbox" id="php-select-all" checked></th>
                        <th>{{ "Translation Key"|t('translation-manager') }}</th>
                        <th>{{ "Value"|t('translation-manager') }}</th>
                        <th>{{ "Current Value"|t('translation-manager') }}</th>
                        <th>{{ "Action"|t('translation-manager') }}</th>
                    </tr>
                </thead>
                <tbody>
        `;

        // New translations
        for (const [key, item] of Object.entries(data.new)) {
            window.phpImportData.push({ key: key, value: item.value, isNew: true });
            tableHtml += `
                <tr>
                    <td><input type="checkbox" class="php-import-checkbox" data-index="${index}" checked></td>
                    <td>${escapeHtml(key)}</td>
                    <td>${escapeHtml(item.value)}</td>
                    <td><span class="light">—</span></td>
                    <td><span class="success">{{ "New"|t('translation-manager') }}</span></td>
                </tr>
            `;
            index++;
        }

        // Existing (will update)
        for (const [key, item] of Object.entries(data.existing)) {
            window.phpImportData.push({ key: key, value: item.newValue, isNew: false });
            tableHtml += `
                <tr style="background-color: #FEF3E2;">
                    <td><input type="checkbox" class="php-import-checkbox" data-index="${index}" checked></td>
                    <td>${escapeHtml(key)}</td>
                    <td>${escapeHtml(item.newValue)}</td>
                    <td>${escapeHtml(item.oldValue) || '<span class="light">{{ "Empty"|t('translation-manager') }}</span>'}</td>
                    <td><span style="color: #E67E22;">{{ "Update"|t('translation-manager') }}</span></td>
                </tr>
            `;
            index++;
        }

        // Unchanged (not added to window.phpImportData - they can't be selected)
        for (const [key, item] of Object.entries(data.unchanged)) {
            tableHtml += `
                <tr class="light">
                    <td><input type="checkbox" class="php-import-checkbox" disabled></td>
                    <td>${escapeHtml(key)}</td>
                    <td>${escapeHtml(item.value)}</td>
                    <td>${escapeHtml(item.value)}</td>
                    <td><span class="light">{{ "Skip"|t('translation-manager') }}</span></td>
                </tr>
            `;
        }

        tableHtml += '</tbody></table>';
        contentDiv.innerHTML = tableHtml;

        // Select all checkbox handler
        document.getElementById('php-select-all')?.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.php-import-checkbox:not(:disabled)');
            checkboxes.forEach(cb => cb.checked = this.checked);
        });

        // Update buttons based on whether there are changes
        if (willProcess === 0) {
            // No changes - show "Select a Different File" button
            buttonsDiv.innerHTML = `
                <button type="button" class="btn submit" id="php-select-different-btn">
                    {{ "Select a Different File"|t('translation-manager') }}
                </button>
            `;
            // Add handler for select different file button
            document.getElementById('php-select-different-btn')?.addEventListener('click', function() {
                document.getElementById('php-preview-section').style.display = 'none';
                document.getElementById('phpFile').value = '';
                document.getElementById('phpLanguage').innerHTML = '<option value="">{{ "Select file first"|t('translation-manager') }}</option>';
                document.getElementById('phpCategory').innerHTML = '<option value="">{{ "Select file first"|t('translation-manager') }}</option>';
                document.getElementById('php-preview-btn').disabled = true;
                phpPreviewData = null;
                window.phpImportData = [];
            });
        } else {
            // Has changes - show normal buttons
            buttonsDiv.innerHTML = `
                <button type="button" class="btn submit" id="php-confirm-import-btn">
                    {{ "Confirm and Import"|t('translation-manager') }}
                </button>
                <button type="button" class="btn" id="php-cancel-btn">
                    {{ "Cancel"|t('translation-manager') }}
                </button>
            `;
            // Re-attach event handlers
            attachPhpImportHandlers();
        }

        previewSection.style.display = 'block';

        if (backupNotice) {
            const shouldShow = backupEnabled && (backupToggle?.value === '1');
            backupNotice.style.display = shouldShow ? 'block' : 'none';
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text ?? '';
        return div.innerHTML;
    }

    // Attach PHP import button handlers (called after dynamic button creation)
    function attachPhpImportHandlers() {
        document.getElementById('php-confirm-import-btn')?.addEventListener('click', handlePhpConfirmImport);
        document.getElementById('php-cancel-btn')?.addEventListener('click', function() {
            document.getElementById('php-preview-section').style.display = 'none';
            phpPreviewData = null;
            window.phpImportData = [];
        });
    }

    // Handle PHP import - reusable function
    async function handlePhpConfirmImport() {
        if (!phpPreviewData) {
            Craft.cp.displayError('No preview data available');
            return;
        }

        const checkboxes = document.querySelectorAll('.php-import-checkbox:checked:not(:disabled)');
        if (checkboxes.length === 0) {
            Craft.cp.displayError('{{ "No translations selected"|t('translation-manager') }}');
            return;
        }

        // Collect selected items from the stored array using indices
        const translations = [];
        checkboxes.forEach(cb => {
            const idx = parseInt(cb.dataset.index, 10);
            if (!isNaN(idx) && window.phpImportData[idx]) {
                translations.push(window.phpImportData[idx]);
            }
        });

        const btn = document.getElementById('php-confirm-import-btn');
        if (btn) {
            btn.classList.add('loading');
            btn.disabled = true;
        }

        try {
            const response = await fetch('{{ actionUrl('translation-manager/php-import/import') }}', {
                method: 'POST',
                headers: {
                    'X-CSRF-Token': '{{ craft.app.request.csrfToken }}',
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    translations: translations,
                    language: phpPreviewData.language,
                    category: phpPreviewData.category,
                    createBackup: document.querySelector('input[name="phpCreateBackup"]')?.value === '1',
                    '{{ craft.app.config.general.csrfTokenName }}': '{{ craft.app.request.csrfToken }}'
                })
            });

            const data = await response.json();

            const resultsDiv = document.getElementById('php-import-results');
            const successDiv = document.getElementById('php-import-success');
            const errorDiv = document.getElementById('php-import-error');

            resultsDiv.style.display = 'block';

            if (data.success) {
                successDiv.textContent = data.message;
                successDiv.style.display = 'block';
                errorDiv.style.display = 'none';

                // Hide preview
                document.getElementById('php-preview-section').style.display = 'none';
                phpPreviewData = null;
                window.phpImportData = [];

                // Reset file selection
                document.getElementById('phpFile').value = '';
                document.getElementById('phpLanguage').innerHTML = '<option value="">{{ "Select file first"|t('translation-manager') }}</option>';
                document.getElementById('phpCategory').innerHTML = '<option value="">{{ "Select file first"|t('translation-manager') }}</option>';
                document.getElementById('php-preview-btn').disabled = true;

                Craft.cp.displayNotice(data.message);
            } else {
                errorDiv.textContent = data.error || 'Import failed';
                errorDiv.style.display = 'block';
                successDiv.style.display = 'none';
            }
        } catch (error) {
            Craft.cp.displayError('Error importing: ' + error.message);
        } finally {
            if (btn) {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }
    }

    // Initial attachment for static buttons (will be re-attached dynamically)
    attachPhpImportHandlers();

    // Load PHP files on page load
    loadPhpFiles();
{% endjs %}
