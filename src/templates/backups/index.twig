{% extends "translation-manager/_layouts/cp" %}
{% set title = "Backups"|t('translation-manager') %}

{% set selectedSubnavItem = 'backups' %}

{% set plugin = craft.app.plugins.getPlugin('translation-manager') %}
{% set crumbs = [
    {
        label: translationHelper.fullName|t('translation-manager'),
        url: url('translation-manager'),
    },
    {
        label: 'Backups'|t('translation-manager'),
        url: url('translation-manager/backups'),
    },
] %}

{% block content %}
    <div class="flex" style="align-items: center; margin-bottom: 1rem;">
        <h2 style="margin: 0;">{{ "Backup History"|t('translation-manager') }}</h2>
        {% if currentUser.can('translationManager:createBackups') %}
        <div style="margin-left: auto;">
            <button type="button" class="btn" id="create-backup-btn">
                <span class="icon backup-icon" aria-hidden="true">{{ svg('@appicons/database.svg') }}</span>
                <span class="spinner backup-spinner hidden" aria-hidden="true"></span>
                <span class="backup-text">{{ "Create Backup Now"|t('translation-manager') }}</span>
            </button>
        </div>
        {% endif %}
    </div>

    <p>{{ "Backups are automatically created when you import translations (if enabled). You can restore or download any backup."|t('translation-manager') }}</p>

    <div style="margin-top: 1rem;">
        {% include 'lindemannrock-base/_partials/backup-list' with {
            idPrefix: 'backup',
            emptyMessage: 'No backup history yet. Backups are created automatically when you import translations.'|t('translation-manager')
        } %}
    </div>

    {% set backupPath = craft.translationManager.backup.getBackupPath() %}
    {% include 'lindemannrock-base/_components/info-box' with {
        message: '<strong>' ~ "Backup Location:"|t('translation-manager') ~ '</strong> <code>' ~ backupPath ~ '</code>'
    } %}

{% include 'lindemannrock-base/_components/plugin-credit' %}
{% endblock %}

{% js %}
    // Load backups asynchronously to prevent page blocking on slow remote volumes
    function loadBackups() {
        fetch('{{ actionUrl('translation-manager/backup/get-backups') }}', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            const loadingDiv = document.getElementById('backup-list-loading');
            const contentDiv = document.getElementById('backup-list-content');
            const tableContainer = document.getElementById('backup-table-container');
            const noBackupsMsg = document.getElementById('backup-empty-message');
            const errorMsg = document.getElementById('backup-error-message');

            // Hide loading, show content
            if (loadingDiv) loadingDiv.style.display = 'none';
            if (contentDiv) contentDiv.classList.remove('hidden');

            if (data.success && data.backups && data.backups.length > 0) {
                // Render backups table
                tableContainer.innerHTML = renderBackupsTable(data.backups);
                noBackupsMsg.classList.add('hidden');
                errorMsg.classList.add('hidden');

                // Initialize menu buttons after rendering
                tableContainer.querySelectorAll('.menubtn').forEach(btn => {
                    if (typeof Craft !== 'undefined' && Craft.MenuBtn) {
                        new Craft.MenuBtn(btn);
                    } else if (typeof Garnish !== 'undefined' && Garnish.MenuBtn) {
                        new Garnish.MenuBtn(btn);
                    }
                });

            } else if (data.success && (!data.backups || data.backups.length === 0)) {
                // No backups found
                tableContainer.innerHTML = '';
                noBackupsMsg.classList.remove('hidden');
                errorMsg.classList.add('hidden');
            } else {
                // Error occurred
                tableContainer.innerHTML = '';
                noBackupsMsg.classList.add('hidden');
                errorMsg.textContent = data.error || 'Failed to load backups';
                errorMsg.classList.remove('hidden');
            }
        })
        .catch(error => {
            const loadingDiv = document.getElementById('backup-list-loading');
            const contentDiv = document.getElementById('backup-list-content');
            const errorMsg = document.getElementById('backup-error-message');

            if (loadingDiv) loadingDiv.style.display = 'none';
            if (contentDiv) contentDiv.classList.remove('hidden');

            errorMsg.textContent = 'Failed to load backups: ' + error.message;
            errorMsg.classList.remove('hidden');
        });
    }

    function renderReasonBadge(badgeHtml) {
        return badgeHtml || '';
    }

    function renderRowActions(actionsHtml) {
        return actionsHtml || '<td class="thin"></td>';
    }

    function renderBackupsTable(backups) {
        let rows = '';
        backups.forEach(backup => {
            const date = escapeHtml((backup.formattedDate || '').toString());
            const user = escapeHtml(backup.user || '');
            const count = new Intl.NumberFormat().format(backup.translationCount ?? 0);
            const size = escapeHtml(backup.formattedSize || '-');
            const typeBadge = renderReasonBadge(backup.typeBadgeHtml);
            const rowActions = renderRowActions(backup.rowActionsHtml);

            rows += `<tr>
                <td>${date}</td>
                <td>${typeBadge}</td>
                <td>${user}</td>
                <td style="color: #28a745;"><strong>${count}</strong></td>
                <td><code style="font-size: 11px;">${size}</code></td>
                ${rowActions}
            </tr>`;
        });

        return `<table class="data fullwidth">
            <thead>
                <tr>
                    <th>{{ "Date"|t('translation-manager')|e('js') }}</th>
                    <th>{{ "Type"|t('translation-manager')|e('js') }}</th>
                    <th>{{ "Created By"|t('translation-manager')|e('js') }}</th>
                    <th>{{ "Translations"|t('translation-manager')|e('js') }}</th>
                    <th>{{ "Size"|t('translation-manager')|e('js') }}</th>
                    <th class="thin">{{ "Actions"|t('translation-manager')|e('js') }}</th>
                </tr>
            </thead>
            <tbody>${rows}</tbody>
        </table>`;
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Load backups on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadBackups();
    });

    document.getElementById('create-backup-btn')?.addEventListener('click', function() {
        const btn = this;
        const icon = btn.querySelector('.backup-icon');
        const spinner = btn.querySelector('.backup-spinner');
        const text = btn.querySelector('.backup-text');

        // Prevent multiple clicks
        if (btn.disabled) {
            return;
        }

        // Show loading state
        btn.classList.add('loading');
        btn.disabled = true;
        icon.classList.add('hidden');
        spinner.classList.remove('hidden');
        text.textContent = '{{ "Creating Backup..."|t('translation-manager') }}';

        fetch('{{ actionUrl('translation-manager/backup/create') }}', {
            method: 'POST',
            headers: {
                'X-CSRF-Token': '{{ craft.app.request.csrfToken }}',
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                '{{ craft.app.config.general.csrfTokenName }}': '{{ craft.app.request.csrfToken }}',
                reason: 'manual'
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Reset button state
            btn.classList.remove('loading');
            btn.disabled = false;
            icon.classList.remove('hidden');
            spinner.classList.add('hidden');
            text.textContent = '{{ "Create Backup Now"|t('translation-manager') }}';

            if (data.success) {
                Craft.cp.displayNotice(data.message || '{{ "Backup created successfully"|t('translation-manager') }}');
                // Reload backups list
                loadBackups();
            } else {
                Craft.cp.displayError(data.error || '{{ "Failed to create backup"|t('translation-manager') }}');
            }
        })
        .catch(error => {
            // Reset button state
            btn.classList.remove('loading');
            btn.disabled = false;
            icon.classList.remove('hidden');
            spinner.classList.add('hidden');
            text.textContent = '{{ "Create Backup Now"|t('translation-manager') }}';

            Craft.cp.displayError('{{ "Failed to create backup"|t('translation-manager') }}: ' + error.message);
        });
    });

    // Restore backup - use event delegation
    document.addEventListener('click', function(e) {
        const restoreLink = e.target.closest('.restore-backup');
        if (!restoreLink) return;

        e.preventDefault();
        e.stopPropagation();

        const backupName = restoreLink.dataset.backup;
        const message = '{{ "Are you sure you want to restore this backup? This will replace all current translations. A backup of the current state will be created before restoring."|t('translation-manager')|e('js') }}';

        if (confirm(message)) {
            Craft.cp.displayNotice('{{ "Starting restore operation..."|t('translation-manager') }}');

            fetch('{{ actionUrl('translation-manager/backup/restore') }}', {
                method: 'POST',
                headers: {
                    'X-CSRF-Token': '{{ craft.app.request.csrfToken }}',
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ backup: backupName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Craft.cp.displayNotice(data.message || 'Backup restored successfully');
                    // Reload backups list after restore
                    setTimeout(() => loadBackups(), 1500);
                } else {
                    Craft.cp.displayError(data.message || 'Failed to restore backup');
                }
            })
            .catch(error => {
                Craft.cp.displayError('Failed to restore backup: ' + error.message);
            });
        }
    });

    // Delete backup - use event delegation to handle dynamically created menu items
    document.addEventListener('click', function(e) {
        const deleteLink = e.target.closest('.delete-backup');
        if (!deleteLink) return;

        e.preventDefault();
        e.stopPropagation();

        const backupName = deleteLink.dataset.backup;
        const deleteUrl = '{{ cpUrl('translation-manager/backup/delete') }}';
        const message = '{{ "Are you sure you want to delete this backup? This action cannot be undone."|t('translation-manager')|e('js') }}';

        if (confirm(message)) {
            Craft.cp.displayNotice('{{ "Deleting backup..."|t('translation-manager') }}');

            fetch(deleteUrl, {
                method: 'POST',
                headers: {
                    'X-CSRF-Token': '{{ craft.app.request.csrfToken }}',
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ backup: backupName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Craft.cp.displayNotice(data.message || 'Backup deleted successfully');
                    // Reload backups list
                    loadBackups();
                } else {
                    Craft.cp.displayError(data.error || 'Failed to delete backup');
                }
            })
            .catch(error => {
                Craft.cp.displayError('Failed to delete backup: ' + error.message);
            });
        }
    });
{% endjs %}
