{% extends "translation-manager/_layouts/cp" %}
{% set title = "Backups"|t('translation-manager') %}
{% set selectedSubnavItem = 'backups' %}

{% set plugin = craft.app.plugins.getPlugin('translation-manager') %}
{% set crumbs = [
    {
        label: plugin.settings.pluginName|t('translation-manager'),
        url: url('translation-manager'),
    },
    {
        label: 'Backups'|t('translation-manager'),
        url: url('translation-manager/backups'),
    },
] %}

{% block content %}
    <div class="flex" style="align-items: center; margin-bottom: 24px;">
        <h2 style="margin: 0;">{{ "Backup History"|t('translation-manager') }}</h2>
        <div style="margin-left: auto;">
            <button type="button" class="btn" id="create-backup-btn">
                <span class="icon backup-icon" aria-hidden="true">{{ svg('@appicons/database.svg') }}</span>
                <span class="spinner backup-spinner hidden" aria-hidden="true"></span>
                <span class="backup-text">{{ "Create Backup Now"|t('translation-manager') }}</span>
            </button>
        </div>
    </div>

    <div id="backup-list-loading" class="centeralign">
        <div class="spinner"></div>
        <p>{{ "Loading backup history..."|t('translation-manager') }}</p>
    </div>

    <div id="backup-list-content" class="hidden">
        {# Backups will be loaded via AJAX to prevent blocking on slow remote volumes #}
        <div id="backups-table-container"></div>

        <div id="no-backups-message" class="hidden">
            <p class="light">{{ "No backups found. Create your first backup using the button above."|t('translation-manager') }}</p>
        </div>

        <div id="backup-error-message" class="hidden error"></div>

        {% set backupPath = craft.translationManager.backup.getBackupPath() %}
        <div id="backup-location-info" style="margin-top: 2rem; padding: 1rem; background: #f3f4f6; border-radius: 4px;">
            <p class="light" style="margin: 0; display: flex; align-items: flex-start; gap: 8px;">
                <svg aria-hidden="true" width="16" height="16" viewBox="0 0 16 16" style="flex-shrink: 0; margin-top: 2px;">
                    <circle cx="8" cy="8" r="7" fill="none" stroke="currentColor" stroke-width="1.5"/>
                    <text x="8" y="12" text-anchor="middle" font-size="11" font-weight="bold" fill="currentColor">i</text>
                </svg>
                <span><strong>{{ "Backup Location:"|t('translation-manager') }}</strong> <code>{{ backupPath }}</code></span>
            </p>
        </div>
    </div>

{% include 'translation-manager/_components/plugin-credit.twig' %}
{% endblock %}

{% js %}
    // Load backups asynchronously to prevent page blocking on slow remote volumes
    function loadBackups() {
        fetch('{{ actionUrl('translation-manager/backup/get-backups') }}', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            const loadingDiv = document.getElementById('backup-list-loading');
            const contentDiv = document.getElementById('backup-list-content');
            const tableContainer = document.getElementById('backups-table-container');
            const noBackupsMsg = document.getElementById('no-backups-message');
            const errorMsg = document.getElementById('backup-error-message');

            // Hide loading, show content
            if (loadingDiv) loadingDiv.style.display = 'none';
            if (contentDiv) contentDiv.classList.remove('hidden');

            if (data.success && data.backups && data.backups.length > 0) {
                // Render backups table
                tableContainer.innerHTML = renderBackupsTable(data.backups);
                noBackupsMsg.classList.add('hidden');
                errorMsg.classList.add('hidden');

                // Initialize menu buttons after rendering
                setTimeout(() => {
                    document.querySelectorAll('.menubtn').forEach(btn => {
                        if (typeof Garnish !== 'undefined' && Garnish.MenuBtn) {
                            new Garnish.MenuBtn(btn);
                        }
                    });
                }, 100);

            } else if (data.success && (!data.backups || data.backups.length === 0)) {
                // No backups found
                tableContainer.innerHTML = '';
                noBackupsMsg.classList.remove('hidden');
                errorMsg.classList.add('hidden');
            } else {
                // Error occurred
                tableContainer.innerHTML = '';
                noBackupsMsg.classList.add('hidden');
                errorMsg.textContent = data.error || 'Failed to load backups';
                errorMsg.classList.remove('hidden');
            }
        })
        .catch(error => {
            const loadingDiv = document.getElementById('backup-list-loading');
            const contentDiv = document.getElementById('backup-list-content');
            const errorMsg = document.getElementById('backup-error-message');

            if (loadingDiv) loadingDiv.style.display = 'none';
            if (contentDiv) contentDiv.classList.remove('hidden');

            errorMsg.textContent = 'Failed to load backups: ' + error.message;
            errorMsg.classList.remove('hidden');
        });
    }

    function renderBackupsTable(backups) {
        let html = `
        <table class="data fullwidth">
            <thead>
                <tr>
                    <th>{{ "Date"|t('translation-manager') }}</th>
                    <th>{{ "Reason"|t('translation-manager') }}</th>
                    <th>{{ "Created By"|t('translation-manager') }}</th>
                    <th>{{ "Translations"|t('translation-manager') }}</th>
                    <th>{{ "Size"|t('translation-manager') }}</th>
                    <th class="thin"></th>
                </tr>
            </thead>
            <tbody>
        `;

        backups.forEach(backup => {
            html += `
                <tr>
                    <td class="thin">${escapeHtml(backup.formattedDate)}</td>
                    <td>${escapeHtml(backup.formattedReason)}</td>
                    <td>${escapeHtml(backup.user)}</td>
                    <td>${backup.translationCount}</td>
                    <td>${escapeHtml(backup.formattedSize)}</td>
                    <td class="thin">
                        <button type="button" class="btn menubtn" data-icon="settings" title="{{ 'Actions'|t('translation-manager') }}"></button>
                        <div class="menu" data-align="right">
                            <ul>
                                <li><a href="#" class="restore-backup" data-backup="${escapeHtml(backup.name)}">
                                    <span class="icon" aria-hidden="true">${'{{ svg("@appicons/share.svg")|e("js") }}'}</span>
                                    {{ "Restore"|t('translation-manager') }}
                                </a></li>
                                <li><a href="{{ actionUrl('translation-manager/backup/download') }}&backup=${encodeURIComponent(backup.name)}">
                                    <span class="icon" aria-hidden="true">${'{{ svg("@appicons/download.svg")|e("js") }}'}</span>
                                    {{ "Download"|t('translation-manager') }}
                                </a></li>
                                <li><hr></li>
                                <li><a href="#" class="delete-backup error" data-backup="${escapeHtml(backup.name)}">
                                    <span class="icon" aria-hidden="true">${'{{ svg("@appicons/trash.svg")|e("js") }}'}</span>
                                    {{ "Delete"|t('translation-manager') }}
                                </a></li>
                            </ul>
                        </div>
                    </td>
                </tr>
            `;
        });

        html += `
            </tbody>
        </table>
        `;

        return html;
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Load backups on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadBackups();
    });

    document.getElementById('create-backup-btn')?.addEventListener('click', function() {
        const btn = this;
        const icon = btn.querySelector('.backup-icon');
        const spinner = btn.querySelector('.backup-spinner');
        const text = btn.querySelector('.backup-text');

        // Prevent multiple clicks
        if (btn.disabled) {
            return;
        }

        // Show loading state
        btn.classList.add('loading');
        btn.disabled = true;
        icon.classList.add('hidden');
        spinner.classList.remove('hidden');
        text.textContent = '{{ "Creating Backup..."|t('translation-manager') }}';

        fetch('{{ actionUrl('translation-manager/backup/create') }}', {
            method: 'POST',
            headers: {
                'X-CSRF-Token': '{{ craft.app.request.csrfToken }}',
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                '{{ craft.app.config.general.csrfTokenName }}': '{{ craft.app.request.csrfToken }}',
                reason: 'manual'
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Reset button state
            btn.classList.remove('loading');
            btn.disabled = false;
            icon.classList.remove('hidden');
            spinner.classList.add('hidden');
            text.textContent = '{{ "Create Backup Now"|t('translation-manager') }}';

            if (data.success) {
                Craft.cp.displayNotice(data.message || '{{ "Backup created successfully"|t('translation-manager') }}');
                // Reload backups list
                loadBackups();
            } else {
                Craft.cp.displayError(data.error || '{{ "Failed to create backup"|t('translation-manager') }}');
            }
        })
        .catch(error => {
            // Reset button state
            btn.classList.remove('loading');
            btn.disabled = false;
            icon.classList.remove('hidden');
            spinner.classList.add('hidden');
            text.textContent = '{{ "Create Backup Now"|t('translation-manager') }}';

            Craft.cp.displayError('{{ "Failed to create backup"|t('translation-manager') }}: ' + error.message);
        });
    });

    // Restore backup - use event delegation
    document.addEventListener('click', function(e) {
        const restoreLink = e.target.closest('.restore-backup');
        if (!restoreLink) return;

        e.preventDefault();
        e.stopPropagation();

        const backupName = restoreLink.dataset.backup;
        const message = '{{ "Are you sure you want to restore this backup? This will replace all current translations. A backup of the current state will be created before restoring."|t('translation-manager')|e('js') }}';

        if (confirm(message)) {
            Craft.cp.displayNotice('{{ "Starting restore operation..."|t('translation-manager') }}');

            fetch('{{ actionUrl('translation-manager/backup/restore') }}', {
                method: 'POST',
                headers: {
                    'X-CSRF-Token': '{{ craft.app.request.csrfToken }}',
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ backup: backupName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Craft.cp.displayNotice(data.message || 'Backup restored successfully');
                    // Reload backups list after restore
                    setTimeout(() => loadBackups(), 1500);
                } else {
                    Craft.cp.displayError(data.message || 'Failed to restore backup');
                }
            })
            .catch(error => {
                Craft.cp.displayError('Failed to restore backup: ' + error.message);
            });
        }
    });

    // Delete backup - use event delegation to handle dynamically created menu items
    document.addEventListener('click', function(e) {
        const deleteLink = e.target.closest('.delete-backup');
        if (!deleteLink) return;

        e.preventDefault();
        e.stopPropagation();

        const backupName = deleteLink.dataset.backup;
        const deleteUrl = '{{ cpUrl('translation-manager/backup/delete') }}';
        const message = '{{ "Are you sure you want to delete this backup? This action cannot be undone."|t('translation-manager')|e('js') }}';

        if (confirm(message)) {
            Craft.cp.displayNotice('{{ "Deleting backup..."|t('translation-manager') }}');

            fetch(deleteUrl, {
                method: 'POST',
                headers: {
                    'X-CSRF-Token': '{{ craft.app.request.csrfToken }}',
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ backup: backupName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Craft.cp.displayNotice(data.message || 'Backup deleted successfully');
                    // Reload backups list
                    loadBackups();
                } else {
                    Craft.cp.displayError(data.error || 'Failed to delete backup');
                }
            })
            .catch(error => {
                Craft.cp.displayError('Failed to delete backup: ' + error.message);
            });
        }
    });
{% endjs %}
