{% extends "translation-manager/_layouts/settings" %}
{% set title = "Translation Sources"|t('translation-manager') %}
{% set fullPageForm = true %}
{% set selectedSettingsItem = 'sources' %}

{% set plugin = craft.app.plugins.getPlugin('translation-manager') %}
{% set crumbs = [
    {
        label: translationHelper.fullName|t('translation-manager'),
        url: url('translation-manager'),
    },
    {
        label: 'Settings'|t('translation-manager'),
        url: url('translation-manager/settings'),
    },
    {
        label: 'Translation Sources'|t('translation-manager'),
        url: url('translation-manager/settings/sources'),
    },
] %}

{% import "_includes/forms" as forms %}

{% block content %}
	{% set formiePluginName = craft.translationManager.getFormiePluginName() %}

	<form method="post" accept-charset="UTF-8">
		{{ csrfInput() }}
		{{ actionInput('translation-manager/settings/save') }}
		{{ redirectInput('translation-manager/settings/sources') }}
		{{ hiddenInput('section', 'sources') }}

		<h2 style="margin-top: 0px;">{{ "Translation Sources"|t('translation-manager') }}</h2>

		{{ forms.lightswitchField({
            label: "Enable Site Translations"|t('translation-manager'),
            instructions: "Capture translations from your templates"|t('translation-manager'),
            id: 'enableSiteTranslations',
            name: 'settings[enableSiteTranslations]',
            on: settings.enableSiteTranslations,
            toggle: 'site-translation-settings',
            disabled: settings.isOverriddenByConfig('enableSiteTranslations'),
            warning: settings.isOverriddenByConfig('enableSiteTranslations') ?
                "This is being overridden by the <code>enableSiteTranslations</code> setting in <code>config/translation-manager.php</code>."|raw : null,
        }) }}

		<div id="site-translation-settings" class="{{ not settings.enableSiteTranslations ? 'hidden' }}">
			{{ forms.textField({
                label: "Site Translation Category"|t('translation-manager'),
                instructions: "The category to use for site translations (e.g. 'lindemannrock' for |t('lindemannrock')). Cannot use reserved categories: site, app, yii, craft."|t('translation-manager'),
                id: 'translationCategory',
                name: 'settings[translationCategory]',
                value: settings.translationCategory,
                errors: settings.getErrors('translationCategory'),
                required: true,
                disabled: settings.isOverriddenByConfig('translationCategory'),
                tip: ("<span id='translation-category-tip'>Use this in your templates: <code>|t('" ~ settings.translationCategory ~ "')</code></span>")|raw,
                warning: settings.isOverriddenByConfig('translationCategory') ?
                    "This is being overridden by the <code>translationCategory</code> setting in <code>config/translation-manager.php</code>."|raw : null,
            }) }}

			{{ forms.textareaField({
                label: "Site Translations Skip Patterns"|t('translation-manager'),
                instructions: ("Text patterns to skip when capturing |t('" ~ settings.translationCategory ~ "') translations (one per line). Does not affect " ~ formiePluginName ~ " fields.")|t('translation-manager'),
                id: 'skipPatterns',
                name: 'settings[skipPatterns]',
                value: settings.skipPatterns|join("\n"),
                rows: 5,
                placeholder: "Example:\nID\nTitle\nStatus"|t('translation-manager'),
                disabled: settings.isOverriddenByConfig('skipPatterns'),
                warning: settings.isOverriddenByConfig('skipPatterns') ?
                    "This is being overridden by the <code>skipPatterns</code> setting in <code>config/translation-manager.php</code>."|raw : null,
            }) }}

			{% if settings.skipPatterns|length > 0 %}
				<div class="field">
					<p class="instructions">
						{{ "Note: Skip patterns only prevent NEW translations from being captured. To remove existing translations that match these patterns, use the button below."|t('translation-manager') }}
					</p>
					<button type="button" class="btn" id="applySkipPatternsBtn">
						{{ "Apply Skip Patterns to Existing Translations"|t('translation-manager') }}
					</button>
				</div>
			{% endif %}
		</div>

		{{ forms.lightswitchField({
            label: ("Enable " ~ formiePluginName ~ " Integration")|t('translation-manager'),
            instructions: ("Automatically capture translations from " ~ formiePluginName)|t('translation-manager'),
            id: 'enableFormieIntegration',
            name: 'settings[enableFormieIntegration]',
            on: settings.enableFormieIntegration,
            disabled: not craft.app.plugins.isPluginEnabled('formie') or settings.isOverriddenByConfig('enableFormieIntegration'),
            warning: settings.isOverriddenByConfig('enableFormieIntegration') ?
                "This is being overridden by the <code>enableFormieIntegration</code> setting in <code>config/translation-manager.php</code>."|raw :
                (not craft.app.plugins.isPluginEnabled('formie') ? (formiePluginName ~ " plugin is not installed")|t('translation-manager') : null),
        }) }}

		<div class="buttons">
			<button type="submit" class="btn submit">{{ "Save"|t('translation-manager') }}</button>
		</div>

	</form>

	{% include 'translation-manager/_components/plugin-credit.twig' %}
{% endblock %}

{% js %}
// Similar JS from original settings page
    document.getElementById('translationCategory').addEventListener('input', function(e) {
        const value = e.target.value.trim();
        const valueLower = value.toLowerCase();
        const field = e.target.closest('.field');
        let warningElement = field.querySelector('.warning');

        // Reserved categories that cannot be used
        const reservedCategories = ['site', 'app', 'yii', 'craft'];
        const isReserved = reservedCategories.includes(valueLower);

        // Update the tip to show current value
        const tipElement = document.getElementById('translation-category-tip');
        if (tipElement) {
            tipElement.innerHTML = 'Use this in your templates: <code>|t(\'' + value + '\')</code>';
        }

        if (isReserved) {
            if (!warningElement) {
                warningElement = document.createElement('p');
                warningElement.className = 'warning';
                field.appendChild(warningElement);
            }
            warningElement.innerHTML = '<span class="icon" aria-hidden="true"></span>' +
                '{{ "Error: Cannot use reserved categories: site, app, yii, craft. Please use a unique identifier like your company name."|t('translation-manager')|e('js') }}';

            if (!this.dataset.confirmed && isReserved) {
                alert('{{ "Cannot use reserved category. The following categories are reserved: site, app, yii, craft. Please use a unique identifier like your company name instead."|t('translation-manager')|e('js') }}');
                this.value = this.defaultValue || '{{ settings.translationCategory|e('js') }}';
                // Update tip back to original value
                if (tipElement) {
                    tipElement.innerHTML = 'Use this in your templates: <code>|t(\'' + (this.defaultValue || '{{ settings.translationCategory|e('js') }}') + '\')</code>';
                }
            }
        } else if (warningElement && !isReserved) {
            if (this.defaultValue && value !== this.defaultValue) {
                warningElement.innerHTML = '<span class="icon" aria-hidden="true"></span>' +
                    '{{ "Changing this will affect all existing site translations. Make sure to update all |t() calls in your templates."|t('translation-manager')|e('js') }}';
            } else {
                warningElement.remove();
            }
        }
    });

    const applySkipPatternsBtn = document.getElementById('applySkipPatternsBtn');
    if (applySkipPatternsBtn) {
        applySkipPatternsBtn.addEventListener('click', function() {
            if (confirm('{{ 'Are you sure you want to remove existing translations that match the skip patterns? This action cannot be undone.'|t('translation-manager')|e('js') }}')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '';
                form.style.display = 'none';

                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = '{{ craft.app.config.general.csrfTokenName }}';
                csrfInput.value = '{{ craft.app.request.csrfToken }}';
                form.appendChild(csrfInput);

                const actionInput = document.createElement('input');
                actionInput.type = 'hidden';
                actionInput.name = 'action';
                actionInput.value = 'translation-manager/settings/apply-skip-patterns';
                form.appendChild(actionInput);

                const redirectInput = document.createElement('input');
                redirectInput.type = 'hidden';
                redirectInput.name = 'redirect';
                redirectInput.value = '{{ 'translation-manager/settings/sources'|hash }}';
                form.appendChild(redirectInput);

                document.body.appendChild(form);
                form.submit();
            }
        });
    }
{% endjs %}
