{% extends "translation-manager/_layouts/settings" %}
{% set title = "Translation Sources"|t('translation-manager') %}
{% set fullPageForm = true %}
{% set selectedSettingsItem = 'sources' %}

{% set crumbs = [
    {
        label: translationHelper.fullName|t('translation-manager'),
        url: url('translation-manager'),
    },
    {
        label: 'Settings'|t('translation-manager'),
        url: url('translation-manager/settings'),
    },
    {
        label: 'Translation Sources'|t('translation-manager'),
        url: url('translation-manager/settings/sources'),
    },
] %}

{% import "_includes/forms" as forms %}

{% block content %}
    {% set formiePluginName = craft.translationManager.getFormiePluginName() %}

    <form method="post" accept-charset="UTF-8">
        {{ csrfInput() }}
        {{ actionInput('translation-manager/settings/save') }}
        {{ redirectInput('translation-manager/settings/sources') }}
        {{ hiddenInput('section', 'sources') }}

        <h2 style="margin-top: 0;">{{ "Site Translations"|t('translation-manager') }}</h2>

        {{ forms.lightswitchField({
            label: "Enable Site Translations"|t('translation-manager'),
            instructions: "Capture translations from your templates"|t('translation-manager'),
            id: 'enableSiteTranslations',
            name: 'settings[enableSiteTranslations]',
            on: settings.enableSiteTranslations,
            toggle: 'site-translation-settings',
            disabled: settings.isOverriddenByConfig('enableSiteTranslations'),
            warning: settings.isOverriddenByConfig('enableSiteTranslations') ?
                "This is being overridden by the <code>enableSiteTranslations</code> setting in <code>config/translation-manager.php</code>."|raw : null,
        }) }}

        <div id="site-translation-settings" class="{{ not settings.enableSiteTranslations ? 'hidden' }}">
            {# Multiple Translation Categories - Editable Table #}
            {% set categoriesTableData = settings.translationCategories|default([]) %}
            {% if categoriesTableData is empty and settings.translationCategory %}
                {# Migrate from old single category format #}
                {% set categoriesTableData = [{'key': settings.translationCategory, 'enabled': true}] %}
            {% endif %}

            {{ forms.editableTableField({
                label: "Translation Categories"|t('translation-manager'),
                instructions: "Define the translation categories to use in your templates (e.g., <code>|t('messages')</code>, <code>|t('emails')</code>). Cannot use reserved categories: site, app, yii, craft."|t('translation-manager')|raw,
                id: 'translationCategories',
                name: 'settings[translationCategories]',
                cols: {
                    key: {
                        heading: "Category Key"|t('translation-manager'),
                        type: 'singleline',
                        info: "Use in templates: |t('key')"|t('translation-manager'),
                        placeholder: "e.g., messages"|t('translation-manager'),
                    },
                    enabled: {
                        heading: "Enabled"|t('translation-manager'),
                        type: 'lightswitch',
                        thin: true,
                    }
                },
                rows: categoriesTableData,
                errors: settings.getErrors('translationCategories'),
                addRowLabel: "Add category"|t('translation-manager'),
                allowAdd: true,
                allowDelete: true,
                allowReorder: true,
                disabled: settings.isOverriddenByConfig('translationCategories'),
                warning: settings.isOverriddenByConfig('translationCategories') ?
                    "This is being overridden by the <code>translationCategories</code> setting in <code>config/translation-manager.php</code>."|raw : null,
            }) }}

            {# Keep deprecated field as hidden for backward compatibility #}
            {{ hiddenInput('settings[translationCategory]', settings.translationCategory) }}

            {% set sourceLanguageOptions = [] %}
            {% for site in craft.app.sites.allSites %}
                {% set langCode = site.language|split('-')|first %}
                {% set sourceLanguageOptions = sourceLanguageOptions|merge([{
                    value: langCode,
                    label: site.name ~ ' (' ~ langCode ~ ')'
                }]) %}
            {% endfor %}
            {# Remove duplicates by converting to unique values #}
            {% set seenLangs = [] %}
            {% set uniqueOptions = [] %}
            {% for option in sourceLanguageOptions %}
                {% if option.value not in seenLangs %}
                    {% set seenLangs = seenLangs|merge([option.value]) %}
                    {% set uniqueOptions = uniqueOptions|merge([option]) %}
                {% endif %}
            {% endfor %}

            {{ forms.selectField({
                label: "Source Language"|t('translation-manager'),
                instructions: "The language your template strings are written in (e.g., 'Copyright', 'Submit'). This should match the language of your |t() keys, not your primary site."|t('translation-manager'),
                id: 'sourceLanguage',
                name: 'settings[sourceLanguage]',
                value: settings.sourceLanguage,
                options: uniqueOptions,
                errors: settings.getErrors('sourceLanguage'),
                required: true,
                disabled: settings.isOverriddenByConfig('sourceLanguage'),
                warning: settings.isOverriddenByConfig('sourceLanguage') ?
                    "This is being overridden by the <code>sourceLanguage</code> setting in <code>config/translation-manager.php</code>."|raw : null,
            }) }}

            <hr>

            {{ forms.textareaField({
                label: "Skip Patterns"|t('translation-manager'),
                instructions: ("Text patterns to skip when capturing site translations (one per line). Does not affect " ~ formiePluginName ~ " fields.")|t('translation-manager'),
                id: 'skipPatterns',
                name: 'settings[skipPatterns]',
                value: settings.skipPatterns|join("\n"),
                rows: 5,
                placeholder: "Example:\nID\nTitle\nStatus"|t('translation-manager'),
                disabled: settings.isOverriddenByConfig('skipPatterns'),
                warning: settings.isOverriddenByConfig('skipPatterns') ?
                    "This is being overridden by the <code>skipPatterns</code> setting in <code>config/translation-manager.php</code>."|raw : null,
            }) }}

            {% if settings.skipPatterns|length > 0 %}
                <div class="field">
                    <p class="instructions">
                        {{ "Note: Skip patterns only prevent NEW translations from being captured. To remove existing translations that match these patterns, use the button below."|t('translation-manager') }}
                    </p>
                    <button type="button" class="btn" id="applySkipPatternsBtn">
                        {{ "Apply Skip Patterns to Existing Translations"|t('translation-manager') }}
                    </button>
                </div>
            {% endif %}
        </div>

        <div class="buttons">
            <button type="submit" class="btn submit">{{ "Save Settings"|t('translation-manager') }}</button>
        </div>

    </form>

    {% include 'lindemannrock-base/_components/plugin-credit' %}
{% endblock %}

{% js %}
    // Validate translation categories in editable table
    const reservedCategories = ['site', 'app', 'yii', 'craft'];

    // Listen for changes in the editable table
    document.addEventListener('input', function(e) {
        if (e.target.matches('#translationCategories input[type="text"]')) {
            const value = e.target.value.trim().toLowerCase();
            const row = e.target.closest('tr');

            if (reservedCategories.includes(value)) {
                e.target.classList.add('error');
                if (!row.querySelector('.category-error')) {
                    const errorSpan = document.createElement('span');
                    errorSpan.className = 'category-error';
                    errorSpan.style.cssText = 'color: #cf1124; font-size: 12px; display: block;';
                    errorSpan.textContent = '{{ "Reserved category - cannot use: site, app, yii, craft"|t('translation-manager')|e('js') }}';
                    e.target.parentNode.appendChild(errorSpan);
                }
            } else {
                e.target.classList.remove('error');
                const errorSpan = row.querySelector('.category-error');
                if (errorSpan) {
                    errorSpan.remove();
                }
            }
        }
    });

    // Apply skip patterns button
    const applySkipPatternsBtn = document.getElementById('applySkipPatternsBtn');
    if (applySkipPatternsBtn) {
        applySkipPatternsBtn.addEventListener('click', function() {
            if (confirm('{{ 'Are you sure you want to remove existing translations that match the skip patterns? This action cannot be undone.'|t('translation-manager')|e('js') }}')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '';
                form.style.display = 'none';

                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = '{{ craft.app.config.general.csrfTokenName }}';
                csrfInput.value = '{{ craft.app.request.csrfToken }}';
                form.appendChild(csrfInput);

                const actionInput = document.createElement('input');
                actionInput.type = 'hidden';
                actionInput.name = 'action';
                actionInput.value = 'translation-manager/settings/apply-skip-patterns';
                form.appendChild(actionInput);

                const redirectInput = document.createElement('input');
                redirectInput.type = 'hidden';
                redirectInput.name = 'redirect';
                redirectInput.value = '{{ 'translation-manager/settings/sources'|hash }}';
                form.appendChild(redirectInput);

                document.body.appendChild(form);
                form.submit();
            }
        });
    }
{% endjs %}
