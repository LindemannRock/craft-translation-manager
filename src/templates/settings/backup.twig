{% extends "translation-manager/_layouts/settings" %}
{% set title = "Backup"|t('translation-manager') %}
{% set fullPageForm = true %}
{% set selectedSettingsItem = 'backup' %}

{% set plugin = craft.app.plugins.getPlugin('translation-manager') %}
{% set crumbs = [
    {
        label: plugin.settings.pluginName|t('translation-manager'),
        url: url('translation-manager'),
    },
    {
        label: 'Settings'|t('translation-manager'),
        url: url('translation-manager/settings'),
    },
    {
        label: 'Backup'|t('translation-manager'),
        url: url('translation-manager/settings/backup'),
    },
] %}

{% import "_includes/forms" as forms %}

{% block content %}
    <form method="post" accept-charset="UTF-8">
        {{ csrfInput() }}
        {{ actionInput('translation-manager/settings/save') }}
        {{ redirectInput('translation-manager/settings/backup') }}

        <h2>{{ "Backup Settings"|t('translation-manager') }}</h2>

        {{ forms.lightswitchField({
            label: "Enable Backups"|t('translation-manager'),
            instructions: "Enable automatic backup functionality for translations"|t('translation-manager'),
            id: 'backupEnabled',
            name: 'backupEnabled',
            on: settings.backupEnabled,
            toggle: 'backup-settings',
            disabled: settings.isOverriddenByConfig('backupEnabled'),
            warning: settings.isOverriddenByConfig('backupEnabled') ?
                "This is being overridden by the <code>backupEnabled</code> setting in <code>config/translation-manager.php</code>."|raw : null,
        }) }}

        <div id="backup-settings" class="{{ not settings.backupEnabled ? 'hidden' }}">
            {{ forms.lightswitchField({
                label: "Backup Before Import"|t('translation-manager'),
                instructions: "Automatically create a backup before importing CSV files"|t('translation-manager'),
                id: 'backupOnImport',
                name: 'backupOnImport',
                on: settings.backupOnImport,
                disabled: settings.isOverriddenByConfig('backupOnImport'),
                warning: settings.isOverriddenByConfig('backupOnImport') ?
                    "This is being overridden by the <code>backupOnImport</code> setting in <code>config/translation-manager.php</code>."|raw : null,
            }) }}

            {{ forms.selectField({
                label: "Backup Schedule"|t('translation-manager'),
                instructions: "How often to create automatic backups. Uses Craft's queue if running, or set up a cron job:"|t('translation-manager') ~ '<br><code style="display: inline-block; margin-top: 4px;">craft translation-manager/backup/scheduled</code>',
                id: 'backupSchedule',
                name: 'backupSchedule',
                value: settings.backupSchedule,
                options: [
                    { label: 'Manual Only', value: 'manual' },
                    { label: 'Daily', value: 'daily' },
                    { label: 'Weekly', value: 'weekly' },
                    { label: 'Monthly', value: 'monthly' },
                ],
                errors: settings.getErrors('backupSchedule'),
                disabled: settings.isOverriddenByConfig('backupSchedule'),
                warning: settings.isOverriddenByConfig('backupSchedule') ?
                    "This is being overridden by the <code>backupSchedule</code> setting in <code>config/translation-manager.php</code>."|raw : null,
            }) }}

            {{ forms.textField({
                label: "Retention Period"|t('translation-manager'),
                instructions: "Number of days to keep automatic backups (0 = keep forever). Manual backups are never deleted automatically."|t('translation-manager'),
                id: 'backupRetentionDays',
                name: 'backupRetentionDays',
                value: settings.backupRetentionDays,
                errors: settings.getErrors('backupRetentionDays'),
                type: 'number',
                min: 0,
                max: 365,
                disabled: settings.isOverriddenByConfig('backupRetentionDays'),
                warning: settings.isOverriddenByConfig('backupRetentionDays') ?
                    "This is being overridden by the <code>backupRetentionDays</code> setting in <code>config/translation-manager.php</code>."|raw : null,
            }) }}

            {# Asset volume selection dropdown for backups #}
            {% set volumeOptions = [{label: 'Use custom path'|t('translation-manager'), value: ''}] %}
            {% for volume in craft.app.volumes.getAllVolumes() %}
                {% set volumeOptions = volumeOptions|merge([{
                    label: volume.name,
                    value: volume.uid
                }]) %}
            {% endfor %}

            {{ forms.selectField({
                label: "Backup Storage Volume"|t('translation-manager'),
                instructions: "Which asset volume should be used for storing backups. Backups will be stored in a 'translation-manager/backups' subdirectory. Note: Cloud storage volumes (Servd, S3, etc.) are not supported for backups and will fall back to local storage."|t('translation-manager'),
                id: 'backupVolumeUid',
                name: 'backupVolumeUid',
                options: volumeOptions,
                value: settings.backupVolumeUid ?? '',
                disabled: settings.isOverriddenByConfig('backupVolumeUid'),
                warning: settings.isOverriddenByConfig('backupVolumeUid') ?
                    "This is being overridden by the <code>backupVolumeUid</code> setting in <code>config/translation-manager.php</code>."|raw : null,
            }) }}

            <div id="custom-backup-path" class="{{ settings.backupVolumeUid ? 'hidden' }}">
                {{ forms.autosuggestField({
                    label: "Custom Backup Path"|t('translation-manager'),
                    instructions: "The custom path where backups should be stored (only used when no volume is selected)"|t('translation-manager'),
                    id: 'backupPath',
                    name: 'backupPath',
                    value: settings.backupPath,
                    errors: settings.getErrors('backupPath'),
                    required: not settings.backupVolumeUid,
                    suggestEnvVars: true,
                    disabled: settings.isOverriddenByConfig('backupPath'),
                    warning: settings.isOverriddenByConfig('backupPath') ?
                        "This is being overridden by the <code>backupPath</code> setting in <code>config/translation-manager.php</code>."|raw : null,
                }) }}
            </div>
        </div>

        <div class="buttons">
            <button type="submit" class="btn submit">{{ "Save"|t('translation-manager') }}</button>
        </div>
    </form>

    {% set backupPath = craft.translationManager.backup.getBackupPath() %}
    <div style="margin-top: 2rem; padding: 1rem; background: #f3f4f6; border-radius: 4px;">
        <p class="light" style="margin: 0; display: flex; align-items: flex-start; gap: 8px;">
            <svg aria-hidden="true" width="16" height="16" viewBox="0 0 16 16" style="flex-shrink: 0; margin-top: 2px;">
                <circle cx="8" cy="8" r="7" fill="none" stroke="currentColor" stroke-width="1.5"/>
                <text x="8" y="12" text-anchor="middle" font-size="11" font-weight="bold" fill="currentColor">i</text>
            </svg>
            <span><strong>{{ "Backup Location:"|t('translation-manager') }}</strong> <code>{{ backupPath }}</code></span>
        </p>
    </div>

    {% include 'translation-manager/_components/plugin-credit.twig' %}
{% endblock %}

{% js %}
    document.addEventListener('DOMContentLoaded', function() {
        const volumeSelect = document.getElementById('backupVolumeUid');
        const customPathDiv = document.getElementById('custom-backup-path');
        const pathField = document.getElementById('backupPath');

        if (volumeSelect) {
            volumeSelect.addEventListener('change', function() {
                if (this.value) {
                    // Volume is selected, hide custom path
                    customPathDiv.classList.add('hidden');
                    pathField.removeAttribute('required');
                } else {
                    // No volume selected, show custom path
                    customPathDiv.classList.remove('hidden');
                    pathField.setAttribute('required', 'required');
                }
            });
        }
    });
{% endjs %}
