{% extends 'lindemannrock-base/_layouts/cp-utilities' %}

{# Permission checks #}
{% set canViewTranslations = currentUser.can('translationManager:manageTranslations') or currentUser.can('translationManager:viewTranslations') %}
{% set canImportExport = currentUser.can('translationManager:manageImportExport') or currentUser.can('translationManager:importTranslations') or currentUser.can('translationManager:exportTranslations') %}
{% set canBackups = currentUser.can('translationManager:manageBackups') %}
{% set canMaintenance = currentUser.can('translationManager:maintenance') or currentUser.can('translationManager:cleanUnused') or currentUser.can('translationManager:scanTemplates') %}
{% set hasNavigation = canViewTranslations or canImportExport or canBackups or canMaintenance %}

{# Calculate coverage colors #}
{% set translatedPercentage = stats.total > 0 ? ((stats.translated / stats.total) * 100)|round : 100 %}
{% set coverageColor = translatedPercentage == 100 ? lrPaletteColor('emerald').color : (translatedPercentage >= 90 ? lrPaletteColor('amber').color : (translatedPercentage >= 70 ? lrPaletteColor('sky').color : lrPaletteColor('red').color)) %}
{% set coverageBadge = translatedPercentage == 100 ? 'Complete'|t('translation-manager') : (translatedPercentage >= 90 ? 'Good'|t('translation-manager') : (translatedPercentage >= 70 ? 'In Progress'|t('translation-manager') : 'Needs Attention'|t('translation-manager'))) %}

{% set utilitiesConfig = {
    plugin: {
        handle: 'translation-manager',
        name: translationHelper.fullName,
    },
    page: {
        title: 'Overview'|t('translation-manager'),
        description: 'Monitor translation coverage, track progress, and manage translations for your multi-site content.'|t('translation-manager'),
        overviewTitle: 'Translation Overview'|t('translation-manager'),
    },
} %}

{% block headerActions %}
    <form method="get" style="margin: 0;">
        <div class="select">
            <select name="siteId" onchange="this.form.submit()">
                {% for site in craft.app.sites.allSites %}
                    <option value="{{ site.id }}" {{ currentSiteId == site.id ? 'selected' : '' }}>
                        {{ site.name }} ({{ site.language|upper }})
                    </option>
                {% endfor %}
            </select>
        </div>
    </form>
{% endblock %}

{% block overview %}
    {# Translation Coverage Card #}
    {% include 'lindemannrock-base/_components/cards/unified-card' with {
        title: 'Translation Coverage'|t('translation-manager'),
        color: coverageColor,
        value: translatedPercentage ~ '%',
        valueColor: coverageColor,
        badge: coverageBadge,
        badgeColor: coverageColor,
        description: 'Translations completed'|t('translation-manager'),
        subBoxes: [
            {value: stats.total, label: 'Total'|t('translation-manager')},
            {value: stats.translated, label: 'Translated'|t('translation-manager'), color: lrPaletteColor('emerald').color},
        ],
    } only %}

    {# Work Queue Card #}
    {% include 'lindemannrock-base/_components/cards/unified-card' with {
        title: 'Work Queue'|t('translation-manager'),
        color: lrPaletteColor('amber').color,
        value: stats.pending,
        description: 'Pending translations'|t('translation-manager'),
        subBoxes: [
            {value: stats.unused, label: 'Unused'|t('translation-manager'), color: lrPaletteColor('gray').color},
        ],
    } only %}

    {# Translation Types Card #}
    {% include 'lindemannrock-base/_components/cards/unified-card' with {
        title: 'Translation Types'|t('translation-manager'),
        color: lrPaletteColor('violet').color,
        value: stats.formie + stats.site,
        description: 'Total translation sources'|t('translation-manager'),
        subBoxes: [
            {value: stats.formie, label: craft.translationManager.getFormiePluginName()},
            {value: stats.site, label: 'Site'|t('translation-manager')},
        ],
    } only %}
{% endblock %}

{% block quickActions %}
    {% if hasNavigation %}
        {% set navButtons = [] %}
        {% if canViewTranslations %}
            {% set navButtons = navButtons|merge([{type: 'link', label: 'Manage Translations'|t('translation-manager'), url: url('translation-manager', {siteId: currentSiteId})}]) %}
        {% endif %}
        {% if canImportExport %}
            {% set navButtons = navButtons|merge([{type: 'link', label: 'Manage Import/Export'|t('translation-manager'), url: url('translation-manager/import-export')}]) %}
        {% endif %}
        {% if canBackups %}
            {% set navButtons = navButtons|merge([{type: 'link', label: 'Manage Backups'|t('translation-manager'), url: url('translation-manager/backups')}]) %}
        {% endif %}
        {% if canMaintenance %}
            {% set navButtons = navButtons|merge([{type: 'link', label: 'Perform Maintenance'|t('translation-manager'), url: url('translation-manager/maintenance')}]) %}
        {% endif %}

        {% include 'lindemannrock-base/_layouts/cp-utilities/_action-section' with {
            title: 'Navigation'|t('translation-manager'),
            description: 'Access main plugin sections'|t('translation-manager'),
            buttons: navButtons,
        } only %}
    {% endif %}
{% endblock %}

{% block additionalContent %}
    {% if stats.siteInfo %}
        <div style="margin-top: 24px; padding: 12px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; text-align: center;">
            <span style="color: #6b7280; font-size: 13px;">
                <strong>{{ "Current Site:"|t('translation-manager') }}</strong> {{ stats.siteInfo.name }} ({{ stats.siteInfo.language|upper }})
            </span>
        </div>
    {% endif %}
{% endblock %}
